#!/usr/bin/env groovy
//                  $$\
//                  $$ |
//   $$$$$$\   $$$$$$$ | $$$$$$\   $$$$$$\
//  $$  __$$\ $$  __$$ |$$  __$$\ $$  __$$\
//  $$$$$$$$ |$$ /  $$ |$$ /  $$ |$$$$$$$$ |
//  $$   ____|$$ |  $$ |$$ |  $$ |$$   ____|
//  \$$$$$$$\ \$$$$$$$ |\$$$$$$$ |\$$$$$$$\
//   \_______| \_______| \____$$ | \_______|
//                      $$\   $$ |
// Â© 2021 Edge Network  \$$$$$$  |
//   Technologies Ltd.   \______/

def imagesPushed = ''

def buildAndPushImage(registry, tag, blockchainApi, indexApi) {
  docker.withRegistry("https://$registry", registry) {
    def image = docker.build("$registry/$tag",
      "--build-arg BLOCKCHAIN_API_URL=$blockchainApi --build-arg INDEX_API_URL=$indexApi .")
    image.push()
    return "$registry/$tag"
  }
}

pipeline {
  agent any
  stages {
    //
    // Notify the team
    //
    stage('Notify') {
      steps {
        slackSend color: 'good', message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}) has started."
      }
    }

    //
    // Build image
    //
    stage('Build') {
      failFast true
      parallel {
        stage('amd64') {
          agent {
            label 'arch-amd64'
          }
          steps {
            script {
              def tag = buildAndPushImage(REGISTRY, NAME, BLOCKCHAIN_API_URL, INDEX_API_URL)

              // Update image list for slack reporting.
              if (imagesPushed == '') imagesPushed = "\n$tag"
              else imagesPushed = "$imagesPushed\n$tag"
            }
          }
        }
      }
    }
  }
  post {
    success {
      script {
        if (imagesPushed != '') {
          slackSend color: 'good', message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}) has completed successfully, pushing images $imagesPushed"
        }
      }
    }
    failure {
      script {
        if (imagesPushed != '') {
          slackSend color: 'danger', message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}) has failed, but pushed images $imagesPushed\n\nView logs: ${env.BUILD_URL}console"
        } else {
          slackSend color: 'danger', message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}) has failed.\n\nView logs: ${env.BUILD_URL}console"
        }
      }
    }
    aborted {
      script {
        if (imagesPushed != '') {
          slackSend color: 'warning', message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}) was aborted, but pushed images $imagesPushed\n\nView logs: ${env.BUILD_URL}console"
        } else {
          slackSend color: 'warning', message: "${env.JOB_NAME} (#${env.BUILD_NUMBER}) was aborted.\n\nView logs: ${env.BUILD_URL}console"
        }
      }
    }
  }
}
